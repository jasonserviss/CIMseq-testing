---
title: "Testing spTopMaxMean"
author: "Jason T. Serviss"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r, message = FALSE}
packages <- c(
    "sp.scRNAseq",
    "sp.scRNAseqData",
    "sp.scRNAseqTesting",
    "printr",
    "ggthemes",
    "tidyverse"
)
purrr::walk(packages, library, character.only = TRUE)
rm(packages)
```

```{r}
counts <- merge(
  countsRegev[rownames(countsRegev) %in% rownames(countsMgfp), ], 
  countsMgfp, 
  by = 0
)
geneNames <- counts[[1]]
counts <- as.matrix(counts[, -1])
rownames(counts) <- geneNames
```

```{r, warning = FALSE, message = FALSE}
cObjSng <- spCounts(counts, matrix(NA, ncol= ncol(counts)))
uObjMaxMean <- spUnsupervised(cObjSng, type = "maxMean", max = 2000)
uObjMax <- spUnsupervised(cObjSng, type = "max", max = 2000)
```

Look at the intersect between returned genes.
```{r}
i <- length(intersect(getData(uObjMax, "selectInd"), getData(uObjMaxMean, "selectInd")))
print(paste0("Of 2000 genes ", i, " intersect i.e. ", 100*(i/2000), "%"))
```

Examine where the genes from the 2 methods intersect if all genes are examined.
```{r, fig.align="center", fig.width=10, fig.height=6}
imax <- spTopMax(cObjSng, 19000)
imean <- spTopMaxMean(cObjSng, 19000)
tibble(max = imax, mean = imean) %>%
  mutate(bool = max == mean) %>%
  mutate(id = rep(1:190, each = 19000 / 190)) %>%
  group_by(id) %>%
  summarize(inters = length(intersect(max, mean)) / 100) %>%
  ggplot() +
  geom_bar(aes(x = id, y = inters), stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  ggthemes::theme_few() +
  labs(x = "genes (binned with 100 genes / bin)", y = "intersect")
```

Which genes are detected with max -  mean that are not detected with max.
```{r, fig.align="center", fig.width=10, fig.height=6}
idxMax <- getData(uObjMax, "selectInd")
idxMaxMean <- getData(uObjMaxMean, "selectInd")
i1 <- idxMaxMean[!idxMaxMean %in% idxMax]
getData(cObjSng, "counts.log")[i1, ] %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%
  as_tibble() %>%
  gather(sample, counts.log, -gene) %>%
  ggplot() +
  geom_jitter(aes(x = gene, y = counts.log), width = 0.2, alpha = 0.1, size = 0.1) +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 90))
```


Which genes are detected with max that are not detected with max -  mean
```{r, fig.align="center", fig.width=10, fig.height=6}
i2 <- idxMax[!idxMax %in% idxMaxMean]
getData(cObjSng, "counts.log")[i2, ] %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%
  as_tibble() %>%
  gather(sample, counts.log, -gene) %>%
  ggplot() +
  geom_jitter(aes(x = gene, y = counts.log), alpha = 0.1, width = 0.2, size = 0.1) +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 90)) 
```

Conclusions:
The gene sets returned using the max - mean or max method to select features 
are largley overlapping. Looking at the distributions of the counts for genes 
returned from each method, nothing particular stands out when comparing the two.
Genes returned are not overly enriched in drop-outs although drop-outs are 
present in all observed genes. Due to the fact that drop-outs are observed in 
the majority of the genes, this would also incicate that they are not house 
keeping genes, which would instead be expected to be highly expressed in all
samples.

```{r}
sessionInfo()
```

