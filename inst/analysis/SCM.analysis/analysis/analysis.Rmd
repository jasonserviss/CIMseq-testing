---
title: "Testing Poisson Swarm Algorithm with Sorted Multiplets Dataset"
author: "Jason T. Serviss"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r, message = FALSE}
#PACKAGES
packages <- c(
  "CIMseq", "CIMseq.data", "CIMseq.testing", "printr", "ggthemes", "dplyr", 
  "ggplot2", "tidyr", "purrr", "stringr"
)
purrr::walk(packages, library, character.only = TRUE)
rm(packages)

##DATA
load("../data/CIMseqData.rda")
load("../data/sObj.rda")

#rename classes
renameClasses <- function(class) {
  case_when(
    class == "0" ~ "A375",
    class == "1" ~ "HCT116",
    class == "2" ~ "HOS",
    TRUE ~ "error"
  )
}

getData(cObjSng, "classification") <- renameClasses(getData(cObjSng, "classification"))
fractions <- getData(sObj, "fractions")
colnames(fractions) <- renameClasses(colnames(fractions))
sObj@fractions <- fractions
```

### Show number of expected edges vs number of observed edges

```{r, fig.align="center", fig.width=10, fig.height=8}
known <- setupPlate(filter(SCM.Meta, !filtered))
res <- checkResults(sObj, known, cObjSng, cObjMul)

d <- res %>% 
  mutate(detected = map(data.detected, function(t){
    ifelse(is.null(t), NA, pull(t, connections))
  })) %>% 
  filter(!is.na(detected)) %>%
  select(detected) %>%
  unnest() %>%
  count(detected)

e <- res %>% 
  mutate(expected = map(data.expected, function(t){
    ifelse(is.null(t), NA, pull(t, connections))
  })) %>% 
  filter(!is.na(expected)) %>%
  select(expected) %>%
  unnest() %>%
  count(expected)

data <- full_join(d, e, by = c("detected" = "expected")) %>% 
  rename(Connection = detected, `Expected (n)` = n.y, `Detected (n)` = n.x) %>%
  replace_na(list(`Expected (n)` = 0, `Detected (n)` = 0)) %>%
  select(Connection, `Expected (n)`, `Detected (n)`)

data

pdf('../figures/figure1.pdf')
gridExtra::grid.table(data, rows = rep("", nrow(data)))
invisible(dev.off())
```

### Show average stats for multiplets dependant on the number of cell in the multiplet.

```{r, fig.align="center", fig.width=10, fig.height=8}
data <- res %>%
  inner_join(SCM.Meta, by = "sample") %>%
  mutate(`Cells (n)` = str_count(cellTypes, "-") + 1) %>%
  group_by(`Cells (n)`) %>%
  summarize(
    `TPR (mean)` = round(mean(TPR, na.rm = TRUE), digits = 2),
    `TNR (mean)` = round(mean(TNR, na.rm = TRUE), digits = 2),
    `ACC (mean)` = round(mean(ACC, na.rm = TRUE), digits = 2)
  )

data

pdf('../figures/figure2.pdf')
gridExtra::grid.table(data, rows = rep("", nrow(data)))
invisible(dev.off())
```

### Show average stats for multiplets dependant on the combination of cells in the multiplet.

```{r, fig.align="center", fig.width=10, fig.height=8}
res %>%
  inner_join(SCM.Meta, by = "sample") %>%
  mutate(cellsInMultiplet = str_count(cellTypes, "-") + 1) %>%
  group_by(cellTypes) %>%
  summarize(
    meanTPR = mean(TPR, na.rm = TRUE),
    meanTNR = mean(TNR, na.rm = TRUE),
    meanACC = mean(ACC, na.rm = TRUE)
  )
```

<br></br>

### Print all stats.

Cell number per class
```{r}
select(cellNumberPerClass(cObjSng, cObjMul), class, medianCellNumber)

print <- res %>% 
  mutate(connections.detected = map_chr(data.detected, ~paste(unlist(.x), collapse = ", "))) %>%
  mutate(connections.expected = map_chr(data.expected, ~paste(unlist(.x), collapse = ", "))) %>%
  select(-(data.detected:data.expected)) %>%
  inner_join(SCM.Meta, by = "sample") %>%
  rename(cellsSorted = cellTypes) %>%
  inner_join(matrix_to_tibble(getData(sObj, "fractions"), "sample"), by = "sample") %>%
  mutate(
    HOS = round(HOS, digits = 5), 
    HCT116 = round(HCT116, digits = 5), 
    A375 = round(A375, digits = 5)
  ) %>%
  unite(fractions, HOS, HCT116, A375, sep = ", ") %>%
  rename("fractions (HOS, HCT116, A375)" = fractions) %>%
  inner_join(matrix_to_tibble(adjustFractions(cObjSng, cObjMul, sObj, binary = FALSE), "sample"), by = "sample") %>%
  unite(`adj. fractions`, HOS, HCT116, A375, sep = ", ") %>%
  inner_join(select(estimateCells(cObjSng, cObjMul), sample, estimatedCellNumber), by = "sample") %>%
  select(
    sample, cellsSorted, connections.expected, connections.detected, 
    `fractions (HOS, HCT116, A375)`, `adj. fractions`, estimatedCellNumber, tp:ACC
  )

as.data.frame(print)
```

```{r}
sessionInfo()
```

