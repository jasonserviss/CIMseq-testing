---
title: "Mouse analysis Enge only"
author: "Jason T. Serviss"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r, message = FALSE}
packages <- c("CIMseq", "CIMseq.data", "tidyverse")
purrr::walk(packages, library, character.only = TRUE)
rm(packages)

##DATA
load('../data/CIMseqData.rda')
load('../data/sObj.rda')
```

```{r, eval = FALSE, echo = FALSE}
#rename classes
renameClasses <- function(class) {
  case_when(
    class == "0" ~ "C.Colonocytes",
    class == "1" ~ "SI.Lgr5+",
    class == "2" ~ "C.Distal.Lgr5+",
    class == "3" ~ "C.Lgr5+.Ki67",
    class == "4" ~ "C.Distal.TA",
    class == "5" ~ "C.Proximal.Lgr5+.1",
    class == "6" ~ "SI.Lgr5+.Mki67h",
    class == "7" ~ "C.Proximal.TA",
    class == "8" ~ "C.Distal.Goblet.marker",
    class == "9" ~ "C.Proximal.Goblet",
    class == "10" ~ "C.Distal.Goblet.Fos",
    class == "11" ~ "SI.Goblet",
    class == "12" ~ "C.Distal.Goblet.Plet1",
    class == "13" ~ "SI.TA.1",
    class == "14" ~ "SI.Lgr5+.Mki67l",
    class == "15" ~ "C.Proximal.Lgr5+.2",
    class == "16" ~ "Enteroendocrine",
    class == "17" ~ "Tufft",
    class == "18" ~ "SI.Enterocytes",
    class == "19" ~ "SI.TA.2",
    class == "20" ~ "SI.Paneth",
    class == "21" ~ "C.Distal.Goblet.Mki67",
    class == "22" ~ "Blood",
    TRUE ~ "error"
  )
}

cOrder <- c(
  "SI.Goblet", "SI.Paneth", "SI.Lgr5+", "SI.Lgr5+.Mki67l", "SI.Lgr5+.Mki67h", "SI.TA.1", "SI.TA.2", "SI.Enterocytes",
  "C.Proximal.Goblet", "C.Proximal.Lgr5+.1", "C.Proximal.Lgr5+.2", "C.Proximal.TA", "C.Colonocytes", "C.Lgr5+.Ki67",
  "C.Distal.Goblet.Mki67", "C.Distal.Goblet.Plet1", "C.Distal.Goblet.Fos", "C.Distal.Goblet.marker", "C.Distal.Lgr5+", "C.Distal.TA",
  "Enteroendocrine", "Tufft", "Blood"
)

getData(cObjSng, "classification") <- renameClasses(getData(cObjSng, "classification"))
fractions <- getData(sObj, "fractions")
colnames(fractions) <- renameClasses(colnames(fractions))
sObj@fractions <- fractions
```

```{r, fig.align="center", fig.width=10, fig.height=8}
plotUnsupervisedClass(cObjSng, cObjMul)
plotUnsupervisedMarkers(
  cObjSng, cObjMul,
  c("Lgr5", "Ptprc", "Chga", "Dclk1", "Alpi", "Slc26a3", "Atoh1", "Lyz1"),
  pal = RColorBrewer::brewer.pal(8, "Set1")
)
plotUnsupervisedMarkers(
  cObjSng, cObjMul,
  c("Mki67", "Hoxb13"),
  pal = RColorBrewer::brewer.pal(8, "Set1")
)
```

```{r, fig.align="center", fig.width=10, fig.height=8}
gene.order <- c(
  "Hoxb13", "Osr2", "Atoh1", "Reg4", "Sval1", "Plet1", "Mki67", "Lgr5", "Alpi", 
  "Slc26a3", "Lyz1", "Dclk1", "Chga", "Ptprc"
)

d <- getData(cObjSng, "counts.cpm")[markers, ] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Sample") %>%
  as_tibble() %>% 
  gather(gene, cpm, -Sample) %>%
  inner_join(tibble(
    Sample = colnames(getData(cObjSng, "counts")), 
    Classification = getData(cObjSng, "classification")
  )) %>%
  mutate(Classification = parse_factor(Classification, levels = cOrder)) %>%
  mutate(gene = parse_factor(gene, levels = gene.order)) %>%
  arrange(Classification, gene) %>%
  mutate(Sample = parse_factor(Sample, levels = unique(Sample))) %>% 
  mutate(type = case_when(
    str_detect(Classification, "^S") ~ "Small intestine",
    str_detect(Classification, "^C") ~ "Colon",
    TRUE ~ "Other"
  )) %>%
  mutate(type = parse_factor(
    type,
    levels = c("Small intestine", "Colon", "Other")
  ))

under <- d %>%
  mutate(idx = 1:nrow(.)) %>% 
  group_by(Classification) %>% 
  summarize(
    min = (min(idx)), max = (max(idx) - 1), median = median(idx)
  ) %>%
  ggplot() +
  geom_segment(
    aes(x = min, xend = max, y = 0, yend = 0, colour = Classification)
  ) +
  geom_text(
    aes(median, y = 0, label = Classification),
    angle = 90, nudge_y = -0.01, hjust = 1, colour = "grey10"
  ) +
  scale_colour_manual(values = col40()) +
  ylim(c(-1, 0)) +
  theme_few() +
  scale_x_continuous(expand = c(0, 0)) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank()
  ) +
  guides(colour = FALSE)

over <- d %>% 
  ggplot() + 
  geom_bar(aes(Sample, cpm, fill = Classification), stat = "identity") + 
  facet_grid(gene ~ type, scales = "free", space = "free_x") +
  scale_fill_manual(values = col40()) +
  theme_few() +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.background.x = element_rect(fill = "white")
  ) +
  labs(y = "CPM") +
  guides(fill = FALSE)

library(patchwork)

p <- over + under + plot_layout(ncol = 1, heights = c(2, 1))
p
```

```{r, eval = FALSE}
cOrder <- c("SmallIntestine", "Blood", "Enteroendo", "Tufft", "Colon", "Colon.d", "Colon.p")
```

```{r, fig.align="center", fig.width=14, fig.height=12}

plotSwarmCircos(sObj, cObjSng, cObjMul, weightCut = 0, classOrder = cOrder)
```

```{r, eval = FALSE, echo = FALSE}
c(
    "SI.Goblet", "SI.Goblet.KI67+", "SI.Paneth", "SI.Lgr5+.KI67-", "SI.Lgr5+.KI67h", 
    "SI.Lgr5+.KI67l", "SI.Lgr5-.KI67l", "SI.Lgr5-.KI67+", "SI.Entero", "SI.Entero.early", 
    "Enteroendo", "Tufft", "Blood",
    "C.Lgr5+.d", "C.TA.d", "C.Lgr5+.KI67+.d", "C.Colonocyte.d",
    "C.Lgr5+.p.2", "C.Lgr5+.p.1", "C.Lgr5+.KI67+.p", "C.Colonocyte.p",
    "C.Goblet.p", "C.Goblet.KI67+", "C.Goblet.d"
)
```

clockwise  
Colon = 5-0 (proximal = 5-8 + 13, distal = 2-14 + 0)  
Other  16-23  
Small intestine = 12-15  

### Filtering

Only detected duplicates and triplicates.  
Only ERCC estimated cell number <= 4.  
Weight cutoff = 5.

```{r, fig.align="center", fig.width=14, fig.height=12}
adj <- adjustFractions(cObjSng, cObjMul, sObj, binary = TRUE)
samples <- rownames(adj)
rs <- rowSums(adj)
keep1 <- rs == 2 | rs == 3
keep2 <- samples %in% filter(estimateCells(cObjSng, cObjMul), estimatedCellNumber <= 4)$sample

plotSwarmCircos(
  filterSwarm(sObj, keep1 & keep2), cObjSng, cObjMul, weightCut = 5, 
  classOrder = cOrder, alpha = 0.01
)
```



