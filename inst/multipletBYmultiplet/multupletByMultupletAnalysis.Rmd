---
title: "One multuplet"
author: "Jason T. Serviss"
date: "30/03/2017"
output: html_document
---


```{r}
library(sp.scRNAseq)
library(ggplot2)
library(ggthemes)
library(plyr)
library(parallel)
library(pso)
library(DESeq2)
library(BiocParallel)
library(dplyr)

load("/Users/jasonserviss/GitHub/sp.scRNAseqTesting/inst/fetalPancreasAnalysis/data.rda")

#try making a heatmap with markers
alphaGenes <- c("GCG", "CHGB", "WIPF3")
betaGenes <- c("INS", "GNAS")
deltaGenes <- c("SST", "PCSK1", "RBP4")
PPgenes <- c("PPY", "ETV1", "PAX6", "ARX")
EpsilonGenes <- c("GHRL", "PHGR1", "GRAMD2")
acinarGenes <- c("PRSS1", "CPA1", "CPA2", "CTRB2", "CTRB1", "CLPS")
endothelialGenes <- c("ESAM", "ICAM2", "FLT1")
mesenchymalGenes <- c("COL1A1", "THY1", "COL3A1", "COL1A2")
ductGenes <- c("SPP1", "DEFB1", "CFTR", "PROM1")
progenitorGenes <- c("NEUROD1", "NEUROG3", "NKX2-2")
endocrineGenes <- c("GCG", "INS", "SST", "PPY", "CHGA", "STMN2")
```

```{r}
name <- 'm.X1000102901.C6'
counts <- getData(cObjMul, "counts")
ercc <- getData(cObjMul, "counts.ercc")

Mul <- as.matrix(counts[,colnames(counts) == name])
MulERCC <- as.matrix(ercc[,colnames(ercc) == name])

colnames(Mul) <- name
colnames(MulERCC) <- name
cObjMulx <- spCounts(Mul, MulERCC)

#note that the spCounts function does not work with only 1 multuplet i.e. counts.log and other slots are wrong, build the object by hand below
cObjMulx@counts <- Mul
cObjMulx@counts.ercc <- MulERCC
cObjMulx@counts.log <- log2(Mul/colSums(Mul)*1000000+1)
cObjMulx@counts.cpm <- Mul/colSums(Mul)*1000000+1


#plot markers and try to determine the cell types in the multuplet.
#m.X1000102901.G4 this seems to only express beta cell markers and therefore might be a singlet.
#m.X1000102901.F1 This appears to be a mesenchymal and endothelial cell although it is difficult to say for sure as FLT1 and THY1 are co-expressed in some single cells.
#m.X1000102901.F10 Unclear what this is, it expresses several markers from multiple different cell types.
#m.X1000102901.C6 This expresses THY1 and SST indicating that it is a delta and mesenchymal cell
#m.X1000102901.D3 This expresses some mesenchymal markers and HADH but not INS, MAFA, or MAFB. Unclear.
#m.X1000102901.C12 This seems to be Beta and mesenchymal due to INS and THY1 expression.
#m.X1000102901.H11 This expressed HADH, HHEX, and THY1 but also ICAM2 and FLT1. Therefore it seems to be endothelial and something else but what is unclear.
#m.X1000102901.A9 This expresses both INS and HADH, indicatig a Beta cell. It also expresses SST, PRSS1, and NEUROD1. Most likely this is a endocrine progenitor and potentially something else.
#m.X1000102901.G2 This would appear to be endothelial and mesenchymal due to THY1/FLT1 expression although it is difficult to say for sure as FLT1 and THY1 are co-expressed in some single cells.
#m.X1000102901.D2 This would appear to be endothelial and mesenchymal due to THY1/FLT1 expression although it is difficult to say for sure as FLT1 and THY1 are co-expressed in some single cells.
#m.X1000102901.A3 Expresses low levels of GCG. In addition it expresses SPP1. The only one for sure is mesenchymal.
#m.X1000102901.D5 Expresses HADH and SPP1 but also THY1 and COL1A1. Unsure.
#m.X1000102901.E7 
#m.X1000102901.E4
#m.X1000102901.G8
#m.X1000102901.A7
#m.X1000102901.B10
#m.X1000102901.F6
#m.X1000102901.E3
#m.X1000102901.G6
#m.X1000102901.E2
#m.X1000102901.B12
#m.X1000102901.A12
#m.X1000102901.C6 Seems to be delta (SST; MORF4L1, FTO, TLE1) and mesenchymal (COL1A1, THY1) although SST is not present as a class in the classification results.
#m.X1000102901.E3 #this seems promising. Despite having some INS and HADH expression, it would seem that it primairly acinar and duct
#m.X1000102901.H2 This would seem that it primairly acinar (CPA1, CPA2, CTRB1, CTRB2) although HHEX, SOX9, and PDX1 expression potentially indicates an progenitor

```

```{r}
#beta
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("INS", "VEGFA"))
```

```{r}
#delta
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("SST", "HHEX")) #MORF4L1, FTO, TLE1
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("SST", "MORF4L1"))
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("SST", "FTO"))
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("SST", "TLE1"))
```

```{r}
#alpha
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("GCG", "TTR"))
```

```{r}
#PP
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("PPY", "ARX"))
```

```{r}
#epsilon
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("GHRL", "PHGR1"))
```

```{r}
#acinar
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("PRSS1", "CPA2")) #CPA1, CTRB1, CTRB2
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("PRSS1", "CPA1")) 
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("PRSS1", "CTRB1")) 
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("PRSS1", "CTRB2")) 
```

```{r}
#eddothelial
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("FLT1", "ICAM2")) #ESAM
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("FLT1", "ESAM"))
```

```{r}
#mesenchymal
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("COL1A1", "THY1"))
```

```{r}
#duct
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("SPP1", "PROM1"))
```

```{r}
#endocrine progenitor
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("NEUROD1", "NEUROG3"))
plotCounts(cObjSng, cObjMulx, type="markers", markers=c("PDX1", "SOX9"))
```

```{r}
#have a look at the cell number in the multiplet
cells <- estimateCells(cObjSng, cObjMulx)
cells %>% filter(grepl("^m", cells$sampleName))

#Results indicate that there is between 2 and 3.5 cells in the multiplet. The median is close to 3. Does this indicate that there is actually a 
#beta cell in the multiplet?

#Have a look at the edges associated with the multiplet
getEdgesForMultiplet(sObj.uw, 1/13.5, name)

#The multiplet is only associated with one edge (H1 and I1). Look at the swarm results and see if this is justified in the reported fraction.
swarm <- getData(sObj.uw, "spSwarm")
swarm[name,]

```

Try to re-run just this multiplets with more iterations
sOnjTest <- spSwarm(cObjMulx, uObj.uw, maxiter=10^4, swarmsize=500)
results are B1, F1, L1:

      A1        B1           C1           D1           E1        F1         G1           H1           I1           J1 K1        L1           M1
 9.505065e-18 0.4975665 8.365903e-17 1.346144e-15 1.053189e-15 0.2066166 0.07116806 2.866097e-17 2.005108e-15 1.232801e-16  0 0.2246489 1.984526e-17

G1 drops below the threshold, otherwise, results are the same

Try Martins "top four" distance function
sObjTest <- spSwarm(cObjMulx, uObj.uw, maxiter=10^3, swarmsize=500, distFun=distToSliceNorm, cores=6)
results are B1, E1, F1, G1, L1

    A1        B1        C1 D1        E1        F1        G1           H1       I1       J1          K1    L1     M1
3.025289e-16 0.1714406  0  0    0.1175577 0.2842746 0.2437676 4.033588e-17 1.16e-15 1.067007e-16    0 0.1829596  0

sObjTest <- spSwarm(cObjMulx, uObj.uw, maxiter=10^3, swarmsize=500, distFun=distToSliceEuclid, cores=6)
results are: B1, F1, G1:

    A1          B1           C1          D1           E1        F1        G1           H1         I1          J1          K1        L1      M1
6.538568e-05 0.2180874 1.108747e-15 0.005972281 2.407715e-16 0.1769206 0.1943084 3.894938e-17 0.02119561 1.02739e-17 0.003703924 0.3797464  0

sObjTest <- spSwarm(cObjMulx, uObj.uw, maxiter=10^3, swarmsize=500, distFun=distToSlicePearson, cores=6)
results are B1, F1, G1, L1:

    A1          B1         C1           D1           E1        F1        G1           H1           I1           J1           K1        L1          M1
3.28533e-16 0.1385967 0.04853738 1.411317e-15 4.461164e-17 0.2039201 0.1673505 1.979421e-17 3.874214e-16 1.289008e-17 5.225426e-16 0.4415953 3.46053e-16

sObjTest <- spSwarm(cObjMulx, uObj.uw, maxiter=10^3, swarmsize=500, distFun="distToSliceTop", cores=6, cells=cells %>% filter(grepl("^m", cells$sampleName)) %>% .$cellNumberMedian)
fractions <- getData(sObjTest, "spSwarm")
fractions[fractions < as.numeric(sort(fractions, decreasing=TRUE)[2])] <- 0

 A1     B1        C1    D1 E1 F1 G1 H1 I1  J1  K1  L1  M1
 0 0.1774989 0.1523387  0  0  0  0  0  0   0   0   0   0